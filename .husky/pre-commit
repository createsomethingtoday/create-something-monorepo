#!/bin/sh
# Ground DRY Check - Pre-commit Hook
# Catches duplicates before they're committed

# Get staged TypeScript/Svelte files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|svelte)$' || true)

if [ -z "$STAGED_FILES" ]; then
  exit 0
fi

# Check if ground exists
GROUND="./packages/ground/target/release/ground"
if [ ! -f "$GROUND" ]; then
  echo "âš ï¸  ground not found, skipping duplicate check"
  exit 0
fi

echo "ðŸ” Checking for duplicates in staged files..."

# Run with strict threshold (90%) on packages directory
RESULT=$($GROUND find duplicates ./packages --threshold 0.90 --extensions ts,svelte 2>&1)

# Check for violations
if echo "$RESULT" | grep -q "No duplicates found"; then
  echo "âœ… No duplicates found"
  exit 0
fi

# Count violations
VIOLATIONS=$(echo "$RESULT" | grep -c "% similar" || echo "0")

if [ "$VIOLATIONS" -gt 0 ]; then
  echo ""
  echo "âš ï¸  Found $VIOLATIONS potential duplicates (>90% similar):"
  echo "$RESULT" | grep -A2 "% similar" | head -20
  echo ""
  echo "Consider consolidating these files or use --no-verify to skip."
  echo "Run 'ground find duplicates ./packages --monorepo' for full analysis."
  # Warning only - don't block commit
  exit 0
fi

exit 0
