# CREATE SOMETHING Terminal (tmux layer)
# Weniger, aber besser.
#
# tmux provides session persistence inside WezTerm.
# WezTerm handles rendering; tmux handles session management.

# ─────────────────────────────────────────────────────────────────
# Core Settings
# ─────────────────────────────────────────────────────────────────
set -g default-terminal "tmux-256color"
set -ga terminal-overrides ",*256col*:Tc"  # True color support
set -g mouse on

# Extended keys: Required for Shift+Enter and other modifiers to pass through
# This enables CSI u mode for proper key sequence handling
set -s extended-keys on
set -ga terminal-features ",*:extkeys"
set -g history-limit 10000                  # Match WezTerm scrollback
set -g escape-time 0                        # No delay on escape
set -g focus-events on
set -g base-index 1                         # Windows start at 1
setw -g pane-base-index 1                   # Panes start at 1

# ─────────────────────────────────────────────────────────────────
# Prefix Key: Ctrl-a (matches WezTerm leader concept)
# ─────────────────────────────────────────────────────────────────
unbind C-b
set -g prefix C-a
bind C-a send-prefix

# ─────────────────────────────────────────────────────────────────
# Keybindings: Match WezTerm grammar where possible
# ─────────────────────────────────────────────────────────────────

# Split panes (prefix + d/D mirrors Cmd+d/Cmd+Shift+d in WezTerm)
bind d split-window -h -c "#{pane_current_path}"   # Horizontal split
bind D split-window -v -c "#{pane_current_path}"   # Vertical split

# Navigate panes: vim-style (h/j/k/l) with prefix
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

# Navigate panes: Alt + vim keys (no prefix, like Cmd+Shift in WezTerm)
bind -n M-h select-pane -L
bind -n M-j select-pane -D
bind -n M-k select-pane -U
bind -n M-l select-pane -R

# Resize panes: prefix + Shift + vim keys
bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5

# Close pane (prefix + w)
bind w kill-pane

# New window (prefix + t, like Cmd+t in WezTerm)
bind t new-window -c "#{pane_current_path}"

# Rename window (prefix + e, like Cmd+Shift+e in WezTerm)
bind e command-prompt -p "Window name:" "rename-window '%%'"

# Clear screen and history (prefix + K, like Cmd+k in WezTerm)
bind K send-keys -R \; clear-history

# Reload config
bind r source-file ~/.tmux.conf \; display "Config reloaded"

# ─────────────────────────────────────────────────────────────────
# Colors: Canon palette (pure black, pure white, muted accents)
# ─────────────────────────────────────────────────────────────────

# Pane borders
set -g pane-border-style "fg=#333333"
set -g pane-active-border-style "fg=#ffffff"

# Status bar: bottom, minimal (matches WezTerm tab_bar_at_bottom)
set -g status-position bottom
set -g status-style "bg=#000000,fg=#666666"
set -g status-left ""
set -g status-right "#[fg=#666666]#S "
set -g status-right-length 20

# Window status (like WezTerm tab styling)
setw -g window-status-style "fg=#666666"
setw -g window-status-format " #W "
setw -g window-status-current-style "fg=#ffffff,bold"
setw -g window-status-current-format " #W "

# Message style
set -g message-style "bg=#000000,fg=#ffffff"
set -g message-command-style "bg=#000000,fg=#ffffff"

# Copy mode (vim-style)
setw -g mode-keys vi
set -g mode-style "bg=#333333,fg=#ffffff"

# ─────────────────────────────────────────────────────────────────
# Clipboard Integration (macOS)
# ─────────────────────────────────────────────────────────────────
# tmux 3.2+ native clipboard support
set -s copy-command 'pbcopy'
set -s set-clipboard on

# Allow passthrough for application-specific sequences (Paste app, etc.)
set -g allow-passthrough on

# Bracketed paste: ensures pasted text isn't interpreted as commands
set -ga terminal-overrides ",*:Ss=\\E[%p1%d q:Se=\\E[2 q"

# Vi copy mode bindings with system clipboard
bind -T copy-mode-vi v send-keys -X begin-selection
bind -T copy-mode-vi y send-keys -X copy-pipe-and-cancel 'pbcopy'
bind -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-pipe-and-cancel 'pbcopy'

# Enter copy mode with prefix + [
bind [ copy-mode

# Paste from system clipboard with prefix + ]
bind ] run "pbpaste | tmux load-buffer - && tmux paste-buffer"

# ─────────────────────────────────────────────────────────────────
# Gastown Integration
# ─────────────────────────────────────────────────────────────────
#
# Session naming convention:
# - gt-coordinator  (global coordinator)
# - gt-witness-<rig> (per-rig lifecycle manager)
# - gt-refinery-<rig> (per-rig merge queue)
# - gt-worker-<n> (ephemeral workers)
#
# Quick attach to Gastown roles: prefix + g, then role key
bind g switch-client -Tgastown
bind -Tgastown c switch-client -t gt-coordinator
bind -Tgastown w switch-client -t gt-witness-csm
bind -Tgastown r switch-client -t gt-refinery-csm
bind -Tgastown s choose-tree -s  # Session picker

# ─────────────────────────────────────────────────────────────────
# Session Management
# ─────────────────────────────────────────────────────────────────

# Switch sessions: prefix + ( / ) for prev/next
bind -r ( switch-client -p
bind -r ) switch-client -n

# Detach (prefix + z, mnemonic: "zzz" = sleep)
bind z detach-client
